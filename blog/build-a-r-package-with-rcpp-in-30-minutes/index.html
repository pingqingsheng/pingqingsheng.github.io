<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="This Site is Under Construction">

<base href="https://pingqingsheng.github.io/">
<title>


     Build a R Package with Rcpp in 30 minutes 

</title>
<link rel="canonical" href="https://pingqingsheng.github.io/blog/build-a-r-package-with-rcpp-in-30-minutes/">








<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>




<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery-scrollTo/2.1.0/jquery.scrollTo.min.js">

<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500|Work+Sans">



    
    <link rel="stylesheet" href="https://pingqingsheng.github.io/css/style.css?t=1493259903">
    




<link rel="shortcut icon"

    href="https://pingqingsheng.github.io/img/fav.ico"

>



<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-97431971-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>






</head>

<body lang="en">
  

<div class="section" id="top">

    <div class="container hero fade-in one">
    <h1 class="bold-title is-1">ZSZ's Blog</h1>
    </div>


<div class="section fade-in two">

    <div class="container">
    <hr>
<nav class="nav nav-center">
    <span id="nav-toggle" class="nav-toggle"  onclick="document.getElementById('nav-menu').classList.toggle('is-active');">
      <span></span>
      <span></span>
      <span></span>
    </span>
    <div id="nav-menu" class="nav-left nav-menu">
      <span class="nav-item">
        <a href="https://pingqingsheng.github.io/">Main</a>
      </span>
      <span class="nav-item">
        <a href="https://pingqingsheng.github.io/#about">About</a> 
      </span>
    
      <span class="nav-item">
        <a href="https://pingqingsheng.github.io/#projects">Projects</a> 
      </span>
    
    
      <span class="nav-item">
        <a href="https://pingqingsheng.github.io/blog">Back to blog</a>
      </span> 
    
      <span class="nav-item">
        <a href="https://pingqingsheng.github.io/#contact">Contact</a>
      </span>
    
      <span class="nav-item">
        <a href="https://pingqingsheng.github.io/index.xml"><i class="fa fa-rss"></i></a>
      </span>
    
    </div>
</nav>
<hr>
    </div>

    <div class="container fade-in two">
        <h2 class="title is-1 top-pad strong-post-title"><a href="https://pingqingsheng.github.io/blog/build-a-r-package-with-rcpp-in-30-minutes/">Build a R Package with Rcpp in 30 minutes</a></h2>
            <div class="post-data">
                April 427, 26047 |
                4 minutes read
            </div>
            
            
                <div class="blog-share">
                Share this:
                <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=Read%20Build%20a%20R%20Package%20with%20Rcpp%20in%2030%20minutes%20https%3a%2f%2fpingqingsheng.github.io%2fblog%2fbuild-a-r-package-with-rcpp-in-30-minutes%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fpingqingsheng.github.io%2fblog%2fbuild-a-r-package-with-rcpp-in-30-minutes%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
                </a>
                <a class="icon-pinterest" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fpingqingsheng.github.io%2fblog%2fbuild-a-r-package-with-rcpp-in-30-minutes%2f&amp;description=Build%20a%20R%20Package%20with%20Rcpp%20in%2030%20minutes"
                onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
                <i class="fa fa-pinterest"></i>
                <span class="hidden">Pinterest</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2fpingqingsheng.github.io%2fblog%2fbuild-a-r-package-with-rcpp-in-30-minutes%2f"
                onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                <i class="fa fa-linkedin"></i>
                <span class="hidden">Google+</span>
                </a>
                </div>
            
            
    </div>

    <div class="container markdown fade-in two top-pad">
        

<p><br />
</p>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
<code> Rcpp </code> is package with which you could write c++ code within R. 
</p>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
You could simply write a inline C++ code in R like this:
</p>

<pre><code class="language-r, echo=TRUE, eval=FALSE">library(Rcpp)

# Define a Rcpp function
add_vec &lt;- Rcpp::cppFunction(
  
  'Rcpp::NumericVector add_vec( Rcpp::NumericVector a, Rcpp::NumericVector b){
  
  return a+b;
  
  }'
  
)

# See the result
t(add_vec(c(1,2,3), c(2,3,4)))

</code></pre>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
Or you could save your <code> .cpp </code> file and call the function from R. With this
powerful tool, you gain the productivity of R and the speed of C++.
</p>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
Let's try to build a small package with <code> Rcpp </code>. Take the Poisson LASSO regression as an example. I'm gonna to install this model with ADMM algorithm and through <code> armidillo </code> package.
</p>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
So let's get start:
</p>

<h3 id="prerequisite"><strong>Prerequisite</strong></h3>

<dl style=' font-family:"Times New Rome"; font-size:14pt '>


+ <code> R </code> 
+ <code> Rcpp </code>
+ <code> RcppArmadillo </code>
</dl>

<p><br />
</p>

<h3 id="build-the-skeleton-of-the-package"><strong>Build the Skeleton of the Package</strong></h3>

<p><code> Rcpp </code> provides function that could help you build a package very quickly. Execute next line will build a package skeleton named &ldquo;PoisLASSO&rdquo; in you working directory:</p>

<pre><code class="language-r, echo=TRUE, eval=FALSE">
Rcpp.package.skeleton('PoisLASSO') # Your package name should go there

</code></pre>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
In the folder PoisLASSO, there is a folder called src where you should put all your C++ files there. Let's build a new C++ file called "*PoisLASSO.cpp*". And we'll put our function in this file.
</p>

<h3 id="poisson-lasso-regression-and-admm-algorithm"><strong>Poisson LASSO Regression and ADMM algorithm</strong></h3>

<p></p>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
I'll skip the detail of this algorithm. But the main idea is to iteratively optimize the objective function and its conjugate problem. The objective function is solved with Lagrange multipler method with augmented variable. And the algorithm is presented as below:
</p>

<pre><code class="language-r, echo=TRUE, engine='Rcpp', eval=FALSE">  
  #include &lt;iostream&gt;
  #include &lt;RcppArmadillo.h&gt;
  //[[Rcpp::depends(RcppArmadillo)]]
  using namespace Rcpp;
  using namespace arma;
  using namespace std;
  
  arma::vec ADMM_Lasso( arma::mat X, arma::colvec Y, double lambda, double eta){

  int nVar  = X.n_cols;
  int marker = 1;
  double tol   = 0.01;
  double tol_1 = 0.1;
  double tol_2 = 0.1;
  int terminate = 0;
  int converge  = 0;

  // Initialization
  arma::vec b_gd    = rnorm(X.n_cols, 0, 1) ;
  arma::vec z_admm  = rnorm(X.n_cols, 0, 1) ;
  arma::vec z_old = z_admm;
  arma::vec mu_admm = rnorm(X.n_cols, 0, 1) ;
  // Using ADAM GD method
  NumericVector m_temp;
  NumericVector v_temp;
  arma::vec m;
  arma::vec v;
  arma::vec steps;
  
  while(!terminate){
    m_temp = rep(0,X.n_cols);
    m = as&lt;arma::vec&gt;(m_temp); 
    v_temp = rep(0,X.n_cols);
    v = as&lt;arma::vec&gt;(v_temp);
    converge  = 0;
    int marker_inner = 0;
    
    // Optimize Beta
    while(!converge){
      arma::vec G_1(X.n_cols);
      arma::vec G_2(X.n_cols);
      arma::vec G_3(X.n_cols);
      arma::vec G(X.n_cols);
      for(int i=0; i&lt;nVar; i++){
        G_1(i) = sum(X.col(i) % Y);
        G_2(i) = sum(exp(X * b_gd) % X.col(i));
      }
      G_3 = (b_gd - z_admm) + mu_admm;
      G = G_1 - G_2 + G_3;
      m = eta * 0.1*m + eta * 0.9*G;
      v = 0.1*v + 0.9*G % G;
      steps = m % pow(v, -0.5);
      b_gd  = b_gd  +  steps;
      Rcout &lt;&lt; &quot;b_gd : &quot; &lt;&lt; trans(b_gd) &lt;&lt; std::endl;
      marker_inner = marker_inner + 1;
      
      if( max(steps) &lt; tol || marker_inner &gt; 20 ){
        converge = 1;
        break;
      }
    }

    // Soft Threshhold Z
    for(int i=0; i&lt;nVar; i++){
      if(b_gd(i)+mu_admm(i) &gt; lambda){
        z_admm(i) = b_gd(i) + mu_admm(i) - lambda;
      }
      else if(b_gd(i)+mu_admm(i) &lt; -lambda){
        z_admm(i) = b_gd(i) + mu_admm(i) + lambda;
      }
      else{
        z_admm(i) = 0;
      }
    }
    
    // For monitor reason
    Rcout &lt;&lt; &quot;z_admm : &quot;  &lt;&lt; trans(z_admm) &lt;&lt; endl;
    // Updating augmented mu
    mu_admm = b_gd - z_admm + mu_admm;
    // For monitor reason
    Rcout &lt;&lt; &quot;mu_admm : &quot; &lt;&lt; trans(mu_admm) &lt;&lt; endl;
    // Check Convergence
    int cond_1 = (max(abs(b_gd - z_admm))  &lt; tol_1);
    int cond_2 = (max(abs(z_admm - z_old)) &lt; tol_2);
    if((cond_1==1) &amp;&amp; (cond_2==1)){
      terminate = 1;
      break;
    }

    z_old = z_admm;
    marker = marker + 1;
    Rcout &lt;&lt; &quot;Iteration : &quot; &lt;&lt; marker &lt;&lt; std::endl;
  }

  Rcpp::Rcout &lt;&lt; trans(b_gd)    &lt;&lt; std::endl ;
  Rcpp::Rcout &lt;&lt; trans(z_admm)  &lt;&lt; std::endl ;
  Rcpp::Rcout &lt;&lt; trans(mu_admm) &lt;&lt; std::endl ;
  return(b_gd);
}

</code></pre>

<h3 id="build-the-package-and-upload-to-github"><strong>Build the Package and Upload to Github</strong></h3>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
Go to the upper directory of your current directory, which contain the PoissLASSO folder. And open your command line (you could do it with <code> devtools </code> as well), and write:
</p>

<pre><code class="language-bash, eval=FALSE, echo=TRUE">R CMD build PoissLASSO
R CMD check PoissLASSO
</code></pre>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
If everything is OK, you could now install your package locally <code> devtools::install('PoissLASSO') </code>.
</p>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
And upload your package to Github with:
</p>

<pre><code class="language-bash, eval=FALSE, echo=TRUE">git init
git add .
git remote add -v &quot;Your Repo URL go here&quot;
git commit -m &quot;First Commit&quot;
git push -u origin master
</code></pre>

<p style=' font-family:"Times New Rome"; font-size:14pt '>
And after finishing this, you should be able to download your own package with 
</p>

<pre><code class="language-r, echo=TRUE, eval=FALSE">devtools::install_github('Your Git Account Name/Your repo name')
library('PoissLASSO')
</code></pre>

    </div>
            
    <div class="disqus">
        <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'test';
    var disqus_identifier = 'https:\/\/pingqingsheng.github.io\/blog\/build-a-r-package-with-rcpp-in-30-minutes\/';
    var disqus_title = 'Build a R Package with Rcpp in 30 minutes';
    var disqus_url = 'https:\/\/pingqingsheng.github.io\/blog\/build-a-r-package-with-rcpp-in-30-minutes\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

<div class="container has-text-centered top-pad">
<hr>
<a href="https://pingqingsheng.github.io/blog/build-a-r-package-with-rcpp-in-30-minutes/#top">TOP</a>
<hr>
</div>

<div class="section" id="footer">
    <div class="container has-text-centered">
        
        <span class="footer-text"><a href="https://github.com/vickylaixy/hugo-theme-introduction" target="_blank">Introduction</a> theme for <a href="http://gohugo.io/" target="_blank">Hugo</a>. Made with <i class="fa fa-heart"></i> and <i class="fa fa-coffee"></i>. <i class="fa fa-copyright"></i> <a href="https://vickylai.com" target="_blank">Vicky Lai</a> 2017</span>
        
    </div>
</div>
</div>
</div>



<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

<script type="application/javascript" src="//cdn.jsdelivr.net/jquery.scrollto/2.1.2/jquery.scrollTo.min.js"></script>

<script type="text/javascript" src=/js/init.js></script>
<script>
  
  $('a[href^="https:\/\/pingqingsheng.github.io\/blog\/build-a-r-package-with-rcpp-in-30-minutes\/#"]').click(function(e) {
    
    e.preventDefault();
    
    
    $(window).stop(true).scrollTo(this.hash, {duration:500, interrupt:false});
  });
  </script>